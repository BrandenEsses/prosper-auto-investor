{% extends "page.html" %}

{% block title %}My Current Notes - Loan Data Viewer{% endblock %}

{% block head_extra %}
    <style>
        /* Styles for rating-badge, note-status-badge, info-icon, note-card-title-grid, note-card-item */
        /* (Same as the previous working version for notes) */
        .rating-badge { @apply badge badge-lg font-semibold text-base-content border-opacity-50; }
        .rating-A { @apply badge-success bg-green-100 border-green-400 text-green-700; }
        /* ... other rating styles ... */
        .rating-default { @apply badge-ghost bg-gray-200 border-gray-400 text-gray-600; }
        .note-status-badge { @apply badge badge-md font-semibold; }
        .note-status-CURRENT { @apply badge-success text-success-content; }
        /* ... other status styles ... */
        .note-status-default { @apply badge-ghost; }
        .info-icon { @apply inline-block ml-1 text-xs text-gray-400 cursor-help; }
        .note-card-title-grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 0.5rem 1rem; align-items: center; width: 100%; }
        @media (min-width: 768px) { .note-card-title-grid { grid-template-columns: minmax(0,0.8fr) minmax(0,1fr) minmax(0,1fr) minmax(0,1.2fr); } }
        .note-card-item { @apply animate-fadeIn; }
    </style>
{% endblock %}

{% block content %}
<main class="flex-grow container mx-auto p-2 sm:p-4 lg:p-6">
    <div class="mb-6 mt-2"><h2 class="text-2xl lg:text-3xl font-bold text-center sm:text-left">My Current Notes</h2></div>

    <div class="bg-base-100 p-4 rounded-xl shadow-lg mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
            <div>
                <label for="filterGlobalSearchNotes" class="label-text pb-1">Global Search</label>
                <input type="text" id="filterGlobalSearchNotes" placeholder="Search all fields..." class="input input-bordered input-sm w-full">
            </div>
            <div>
                <label for="filterNoteStatus" class="label-text pb-1">Note Status</label>
                <select id="filterNoteStatus" class="select select-bordered select-sm w-full">
                    <option value="">All Statuses</option> <option value="CURRENT">Current</option>
                    <option value="LATE">Late</option><option value="COMPLETED">Completed</option>
                </select>
            </div>
            <div>
                <label for="filterNoteRating" class="label-text pb-1">Prosper Rating</label>
                <select id="filterNoteRating" class="select select-bordered select-sm w-full">
                    <option value="">All Ratings</option>
                    <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                    <option value="D">D</option><option value="E">E</option>
                </select>
            </div>
            <div>
                <label for="sortNoteCriteria" class="label-text pb-1">Sort By</label>
                <select id="sortNoteCriteria" class="select select-bordered select-sm w-full">
                    <option value="origination_date_desc" selected>Orig. Date (Newest First)</option>
                    <option value="origination_date_asc">Orig. Date (Oldest First)</option>
                    <option value="principal_balance_desc">Balance (High to Low)</option>
                    <option value="principal_balance_asc">Balance (Low to High)</option>
                    <option value="lender_yield_desc">Yield (High to Low)</option>
                    <option value="lender_yield_asc">Yield (Low to High)</option>
                    <option value="next_payment_date_asc">Next Payment (Soonest)</option>
                    <option value="next_payment_date_desc">Next Payment (Latest)</option>
                    <option value="days_past_due_desc">Days Past Due (Most)</option>
                    <option value="default">Original Order</option>
                </select>
            </div>
            <div> <button id="resetNoteFilters" class="btn btn-ghost btn-sm w-full md:w-auto">Reset Filters</button> </div>
        </div>
    </div>

    <div id="notesContainer" class="space-y-4">
    {% if data and data.result %}
        {% for note in data.result %}
            {# Construct searchable content string #}
            {% set searchable_parts = [
                note.note_status_description,
                note.prosper_rating,
                note.loan_note_id,
                note.loan_number,
                note.listing_number,
                note.next_payment_due_date.split(' ')[0] if note.next_payment_due_date else None,
                note.origination_date.split(' ')[0] if note.origination_date else None,
                ((note.term / 12)|int ~ " Years") if note.term else None,
                (note.lender_yield * 100 ~ "%") if note.lender_yield is number else None,
                note.principal_balance_pro_rata_share,
                note.amount_borrowed,
                note.next_payment_due_amount_pro_rata_share,
                note.accrued_interest,
                note.days_past_due
            ] %}
            {% set searchable_string = searchable_parts 
                |map('string')
                |select('ne', 'None')
                |map('trim')
                |reject('eq', '')
                |join(' ')|lower 
            %}

        <div class="note-card-item bg-base-100 shadow-lg rounded-xl border-l-4 border-secondary"
             data-searchable-content="{{ searchable_string|e }}"
             data-status="{{ note.note_status_description|upper|replace(' ', '_')|replace('.', '')|e if note.note_status_description else '' }}"
             data-rating="{{ note.prosper_rating|upper if note.prosper_rating else '' }}"
             data-balance="{{ note.principal_balance_pro_rata_share }}"
             data-yield="{{ note.lender_yield }}"
             data-nextpaymentdate="{{ note.next_payment_due_date|e if note.next_payment_due_date else '9999-12-31' }}"
             data-dayspastdue="{{ note.days_past_due if note.days_past_due is number else 0 }}"
             data-originationdate="{{ note.origination_date|e if note.origination_date else '1900-01-01' }}"
             data-id="{{ note.loan_note_id|e }}">
            {# ... rest of the card HTML as in the previous correct version ... #}
            <div class="flex items-start space-x-3 md:space-x-4 p-3 md:p-4">
                <input type="radio" name="selected_note_main_group" value="{{ note.loan_note_id }}" class="radio radio-secondary radio-sm sm:radio-md mt-3 md:mt-4 shrink-0">
                <div class="flex-grow collapse collapse-arrow min-w-0">
                    <input type="checkbox" /> 
                    <div class="collapse-title !p-0 !pr-8 md:!pr-10">
                        <div class="note-card-title-grid py-1">
                            <div class="flex flex-col text-sm"> <span class="font-semibold text-neutral-focus">Orig. {{ note.origination_date.split(' ')[0] if note.origination_date else 'N/A' }}</span> <span class="text-xs text-gray-500">{{note.age_in_months}} months old</span> </div>
                            <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-2"> <span class="rating-badge rating-{{ note.prosper_rating|upper if note.prosper_rating else 'default' }} mb-1 sm:mb-0">{{ note.prosper_rating|upper if note.prosper_rating else 'N/A' }}</span> <span class="note-status-badge note-status-{{ note.note_status_description|upper|replace(' ', '_')|replace('.', '') if note.note_status_description else 'default' }}">{{ note.note_status_description if note.note_status_description else 'N/A' }}</span> </div>
                            <div class="flex flex-col"> <span class="font-semibold text-base md:text-lg text-neutral-focus">${{ "%.2f"|format(note.principal_balance_pro_rata_share) }}</span> <span class="text-xs text-gray-500">Principal Balance</span> </div>
                            <div class="flex flex-col"> <span class="text-sm font-semibold text-neutral-focus">{{ "%.2f%%"|format(note.lender_yield * 100) }} Yield</span> {% if note.next_payment_due_date %} <span class="text-xs text-gray-600">Next: {{ note.next_payment_due_date.split(' ')[0] }} (${{ "%.2f"|format(note.next_payment_due_amount_pro_rata_share) }})</span> {% else %} <span class="text-xs text-gray-500 italic">No upcoming pmt</span> {% endif %} </div>
                        </div>
                    </div>
                    <div class="collapse-content bg-base-200/60 p-3 md:p-4 !pb-2 rounded-b-lg -mt-1">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 text-sm"> <div><h5 class="font-semibold text-neutral-600 mb-1">Loan Terms</h5> <p>Orig. Amount: <span class="font-medium text-neutral-focus">${{ "%.2f"|format(note.amount_borrowed) }}</span></p> <p>Term: <span class="font-medium text-neutral-focus">{{ (note.term / 12)|int }} Years</span></p> <p>Borrower Rate: <span class="font-medium text-neutral-focus">{{ "%.2f%%"|format(note.borrower_rate * 100) }}</span></p> </div> <div><h5 class="font-semibold text-neutral-600 mb-1">Payment Status</h5> <p>Days Past Due: <span class="font-medium {{ 'text-error' if note.days_past_due > 0 else 'text-neutral-focus' }}">{{ note.days_past_due }}</span></p> <p>Interest Paid: <span class="font-medium text-neutral-focus">${{ "%.2f"|format(note.interest_paid_pro_rata_share) }}</span></p> <p>Principal Paid: <span class="font-medium text-neutral-focus">${{ "%.2f"|format(note.principal_paid_pro_rata_share) }}</span></p> <p>Accrued Interest: <span class="font-medium text-neutral-focus">${{ "%.2f"|format(note.accrued_interest) }}</span></p> </div> <div><h5 class="font-semibold text-neutral-600 mb-1">Identifiers</h5> <p>Note ID: <span class="font-medium text-neutral-focus">{{ note.loan_note_id }}</span></p> <p>Loan No: <span class="font-medium text-neutral-focus">{{ note.loan_number }}</span></p> <p>Listing No: <span class="font-medium text-neutral-focus">{{ note.listing_number }}</span></p> </div> </div> <div class="mt-4 flex justify-end items-center"> <button class="btn btn-link btn-secondary btn-xs sm:btn-sm p-0">View Full Note Details</button> </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% endif %}
    <div id="noNotesMessage" class="text-center py-10 bg-base-100 rounded-xl shadow" style="display: none;">
        <p class="text-xl text-gray-500">No notes match your criteria.</p>
    </div>
    </div> 
</main>
{% endblock %}

{% block scripts %}
<script>
// JavaScript for filtering and sorting (same as the previous working version for notes, with fixed datasetAttr logic)
document.addEventListener('DOMContentLoaded', function () {
    const globalSearchInput = document.getElementById('filterGlobalSearchNotes'); 
    const filterStatusSelect = document.getElementById('filterNoteStatus');
    const filterRatingSelect = document.getElementById('filterNoteRating');
    const sortCriteriaSelect = document.getElementById('sortNoteCriteria');
    const notesContainer = document.getElementById('notesContainer');
    const resetFiltersButton = document.getElementById('resetNoteFilters');
    const noResultsMessageEl = document.getElementById('noNotesMessage');
    const originalNotes = Array.from(notesContainer.querySelectorAll('.note-card-item'));

    function applyNoteFiltersAndSort() {
        const globalSearchTerm = globalSearchInput.value.toLowerCase().trim();
        const statusFilter = filterStatusSelect.value;
        const ratingFilter = filterRatingSelect.value;
        const sortValue = sortCriteriaSelect.value;
        let items = Array.from(originalNotes); 
        items = items.filter(item => {
            const itemSearchableContent = item.dataset.searchableContent || '';
            const itemStatus = item.dataset.status;
            const itemRating = item.dataset.rating;
            const globalSearchMatch = globalSearchTerm === '' || itemSearchableContent.includes(globalSearchTerm);
            const statusMatch = statusFilter === '' || itemStatus === statusFilter;
            const ratingMatch = ratingFilter === '' || itemRating === ratingFilter;
            return globalSearchMatch && statusMatch && ratingMatch; 
        });
        if (sortValue !== 'default') {
            const parts = sortValue.split('_'); const order = parts.pop(); const keyString = parts.join('_'); 
            let datasetAttr; 
            switch (keyString) {
                case 'origination_date': datasetAttr = 'originationdate'; break;
                case 'principal_balance': datasetAttr = 'balance'; break;
                case 'lender_yield': datasetAttr = 'yield'; break;
                case 'next_payment_date': datasetAttr = 'nextpaymentdate'; break;
                case 'days_past_due': datasetAttr = 'dayspastdue'; break;
                default: datasetAttr = null;
            }
            if(datasetAttr){ 
                 items.sort((a, b) => {
                    let valA_raw = a.dataset[datasetAttr]; let valB_raw = b.dataset[datasetAttr];
                    let valA, valB;
                    if (datasetAttr === 'nextpaymentdate' || datasetAttr === 'originationdate') {
                        valA = valA_raw === '9999-12-31' || valA_raw === '1900-01-01' ? (order === 'asc' ? Infinity : -Infinity) : new Date(valA_raw).getTime();
                        valB = valB_raw === '9999-12-31' || valB_raw === '1900-01-01' ? (order === 'asc' ? Infinity : -Infinity) : new Date(valB_raw).getTime();
                    } else { valA = parseFloat(valA_raw); valB = parseFloat(valB_raw); }
                    const isNaNA = isNaN(valA); const isNaNB = isNaN(valB);
                    if (isNaNA && isNaNB) return 0; if (isNaNA) return 1; if (isNaNB) return -1; 
                    let c = 0; if (valA < valB) c = -1; if (valA > valB) c = 1;
                    return order === 'asc' ? c : -c;
                });
            }
        }
        while (notesContainer.firstChild && notesContainer.firstChild.id !== 'noNotesMessage') { notesContainer.removeChild(notesContainer.firstChild); }
        if (items.length > 0) { items.forEach(item => notesContainer.insertBefore(item, noResultsMessageEl)); if (noResultsMessageEl) noResultsMessageEl.style.display = 'none'; }
        else { if (noResultsMessageEl) noResultsMessageEl.style.display = 'block'; }
    }
    function resetNoteAll() { /* ... same as before ... */ 
        globalSearchInput.value = ''; filterStatusSelect.value = ''; filterRatingSelect.value = ''; 
        sortCriteriaSelect.value = 'origination_date_desc';
        while (notesContainer.firstChild && notesContainer.firstChild.id !== 'noNotesMessage') { notesContainer.removeChild(notesContainer.firstChild); }
        originalNotes.forEach(item => notesContainer.insertBefore(item, noResultsMessageEl));
        if (noResultsMessageEl) noResultsMessageEl.style.display = originalNotes.length === 0 ? 'block' : 'none';
        applyNoteFiltersAndSort();
    }
    globalSearchInput.addEventListener('input', applyNoteFiltersAndSort); 
    filterStatusSelect.addEventListener('change', applyNoteFiltersAndSort);
    filterRatingSelect.addEventListener('change', applyNoteFiltersAndSort);
    sortCriteriaSelect.addEventListener('change', applyNoteFiltersAndSort);
    resetFiltersButton.addEventListener('click', resetNoteAll);
    if (originalNotes.length > 0) { applyNoteFiltersAndSort(); if (noResultsMessageEl) noResultsMessageEl.style.display = 'none'; }
    else if (noResultsMessageEl) { noResultsMessageEl.style.display = 'block'; }
});
</script>
{% endblock %}