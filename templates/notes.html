{% extends "page.html" %}

{% block title %}My Notes{% endblock %}

{% block head_extra %}
    <style>
        .note-card-item { } /* JS Selector */
        /* Styles for rating badges */
        .rating-badge { @apply badge badge-lg font-semibold text-base-content border-opacity-50; }
        .rating-A { @apply badge-success bg-green-100 border-green-400 text-green-700; }
        .rating-B { @apply badge-info bg-blue-100 border-blue-400 text-blue-700; }
        .rating-C { @apply badge-warning bg-yellow-100 border-yellow-500 text-yellow-800; }
        .rating-D { @apply bg-orange-100 border-orange-500 text-orange-700; }
        .rating-E { @apply bg-red-100 border-red-500 text-red-700; }
        .rating-default { @apply badge-ghost bg-gray-200 border-gray-400 text-gray-600; }
        /* Styles for note status badges */
        .note-status-badge { @apply badge badge-md font-semibold; }
        .note-status-CURRENT { @apply badge-success text-success-content; }
        .note-status-LATE { @apply badge-error text-error-content; }
        .note-status-COMPLETED { @apply badge-info text-info-content; }
        .note-status-default { @apply badge-ghost; }
        /* Layout grid for the collapsed card view */
        .note-card-title-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr); 
            gap: 0.5rem 1rem; align-items: center; width: 100%;
        }
        @media (min-width: 768px) {
            .note-card-title-grid { grid-template-columns: minmax(0,0.8fr) minmax(0,1fr) minmax(0,1fr) minmax(0,1.2fr); }
        }
    </style>
{% endblock %}

{% block content %}
<main class="flex-grow container mx-auto p-2 sm:p-4 lg:p-6">
    <div class="mb-6 mt-2">
        <h2 class="text-2xl lg:text-3xl font-bold text-center sm:text-left">
            My Notes 
            {% if total_count is defined %}
                <span class="text-base-content/50 font-normal text-2xl">({{ total_count }})</span>
            {% endif %}
        </h2>
    </div>
    <div class="bg-base-100 p-4 rounded-xl shadow-lg mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
            <div>
                <label for="filterNoteStatus" class="label-text pb-1">Note Status</label>
                <select id="filterNoteStatus" class="select select-bordered select-sm w-full">
                    <option value="">All Statuses</option>
                    <option value="CURRENT">Current</option>
                    <option value="LATE">Late</option>
                    <option value="COMPLETED">Completed</option>
                </select>
            </div>
            <div>
                <label for="filterNoteRating" class="label-text pb-1">Prosper Rating</label>
                <select id="filterNoteRating" class="select select-bordered select-sm w-full">
                    <option value="">All Ratings</option>
                    <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                    <option value="D">D</option><option value="E">E</option>
                </select>
            </div>
            <div>
                <label for="sortNoteCriteria" class="label-text pb-1">Sort By</label>
                <select id="sortNoteCriteria" class="select select-bordered select-sm w-full">
                    <option value="origination_date_desc" selected>Orig. Date (Newest)</option>
                    <option value="principal_balance_desc">Balance (High to Low)</option>
                    <option value="next_payment_date_asc">Next Payment (Soonest)</option>
                </select>
            </div>
            <div> <button id="resetNoteFilters" class="btn btn-ghost btn-sm w-full md:w-auto">Reset</button> </div>
        </div>
    </div>

    <div id="notesContainer" class="space-y-4">
    {% if data and data.result %}
        {% for note in data.result %}
            <div class="note-card-item"
                 data-status="{{ note.note_status_description|upper|replace(' ', '_')|replace('.', '')|e if note.note_status_description else '' }}"
                 data-rating="{{ note.prosper_rating|upper if note.prosper_rating else '' }}"
                 data-balance="{{ note.principal_balance_pro_rata_share }}"
                 data-yield="{{ note.lender_yield }}"
                 data-nextpaymentdate="{{ note.next_payment_due_date|e if note.next_payment_due_date else '9999-12-31' }}"
                 data-dayspastdue="{{ note.days_past_due if note.days_past_due is number else 0 }}"
                 data-originationdate="{{ note.origination_date|e if note.origination_date else '1900-01-01' }}">
                {% with item=note, card_type='note' %}
                    {% include '_card.html' %}
                {% endwith %}
            </div>
        {% endfor %}
    {% else %}
        <div class="text-center py-10 bg-base-100 rounded-xl shadow"><p class="text-xl text-gray-500">No owned notes found in cache.</p></div>
    {% endif %}
    <div id="noNotesMessage" class="text-center py-10 bg-base-100 rounded-xl shadow" style="display: none;">
        <p class="text-xl text-gray-500">No notes match your criteria.</p>
    </div>
    </div> 
</main>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const filterStatusSelect = document.getElementById('filterNoteStatus');
    const filterRatingSelect = document.getElementById('filterNoteRating');
    const sortCriteriaSelect = document.getElementById('sortNoteCriteria');
    const notesContainer = document.getElementById('notesContainer');
    const resetFiltersButton = document.getElementById('resetNoteFilters');
    const noResultsMessageEl = document.getElementById('noNotesMessage');

    if (!filterStatusSelect) return; // Stop script if controls aren't on this page

    const originalNotes = Array.from(notesContainer.querySelectorAll('.note-card-item'));

    function applyNoteFiltersAndSort() {
        const statusFilter = filterStatusSelect.value;
        const ratingFilter = filterRatingSelect.value;
        let items = Array.from(originalNotes); 

        items.forEach(item => {
            const itemStatus = item.dataset.status;
            const itemRating = item.dataset.rating;
            const statusMatch = statusFilter === '' || itemStatus === statusFilter;
            const ratingMatch = ratingFilter === '' || itemRating === ratingFilter;
            
            item.style.display = (statusMatch && ratingMatch) ? '' : 'none';
        });
    }
    filterStatusSelect.addEventListener('change', applyNoteFiltersAndSort);
    filterRatingSelect.addEventListener('change', applyNoteFiltersAndSort);
    resetFiltersButton.addEventListener('click', () => {
        filterStatusSelect.value = '';
        filterRatingSelect.value = '';
        applyNoteFiltersAndSort();
    });
    applyNoteFiltersAndSort();
});
</script>
{% endblock %}