{% extends "page.html" %}

{% block title %}Available Listings{% endblock %}

{% block head_extra %}
    <style>
        /* Styles needed for the listing cards displayed on this page */
        .listing-card-item { } /* JS Selector */
        .rating-badge { @apply badge badge-lg font-semibold text-base-content border-opacity-50; }
        .rating-A { @apply badge-success bg-green-100 border-green-400 text-green-700; }
        .rating-B { @apply badge-info bg-blue-100 border-blue-400 text-blue-700; }
        .rating-C { @apply badge-warning bg-yellow-100 border-yellow-500 text-yellow-800; }
        .rating-D { @apply bg-orange-100 border-orange-500 text-orange-700; }
        .rating-E { @apply bg-red-100 border-red-500 text-red-700; }
        .rating-default { @apply badge-ghost bg-gray-200 border-gray-400 text-gray-600; }
        .verification-dot { @apply h-3 w-3 rounded-full inline-block mx-0.5; }
        .info-icon { @apply inline-block ml-1 text-xs text-gray-400 cursor-help; }
        .custom-collapse-title-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.75rem; align-items: center; width: 100%; }
        .custom-collapse-title-grid > div:last-child { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 0.5rem 1rem; }
        @media (min-width: 1024px) { .custom-collapse-title-grid > div:last-child { grid-template-columns: minmax(0,0.8fr) minmax(0,1.5fr) minmax(0,1fr) minmax(0,1.2fr); } }
        @media (min-width: 768px) and (max-width: 1023px) { .custom-collapse-title-grid > div:last-child { grid-template-columns: minmax(0,1.5fr) minmax(0,1fr) minmax(0,1.2fr); } }
    </style>
{% endblock %}

{% block content %}
<main class="flex-grow container mx-auto p-2 sm:p-4 lg:p-6">
    <div class="mb-6 mt-2"><h2 class="text-2xl lg:text-3xl font-bold text-center sm:text-left">Available Listings</h2></div>
    <div class="bg-base-100 p-4 rounded-xl shadow-lg mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
            <div><label for="filter-global-listings" class="label-text pb-1">Global Search</label><input type="text" id="filter-global-listings" placeholder="Search ID, title, rating..." class="input input-bordered input-sm w-full"></div>
            <div><label for="filter-rating-listings" class="label-text pb-1">Rating</label><select id="filter-rating-listings" class="select select-bordered select-sm w-full"><option value="">All</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option></select></div>
            <div><label for="sort-criteria-listings" class="label-text pb-1">Sort By</label><select id="sort-criteria-listings" class="select select-bordered select-sm w-full"><option value="creation_date_desc" selected>Newest</option><option value="yield_desc">Yield (High-Low)</option></select></div>
            <div><button id="reset-filters-listings" class="btn btn-ghost btn-sm w-full md:w-auto">Reset</button></div>
        </div>
    </div>
    <div id="listingsContainer" class="space-y-4">
    {% if data and data.result %}
        {% for listing in data.result %}
            <div class="listing-card-item"
                 data-searchable-content="{{ [listing.listing_title, listing.listing_number, listing.prosper_rating]|map('string')|join(' ')|lower }}"
                 data-rating="{{ listing.prosper_rating|upper if listing.prosper_rating else '' }}"
                 data-yield="{{ listing.lender_yield }}"
                 data-creation-date="{{ listing.listing_creation_date|e if listing.listing_creation_date else '1900-01-01' }}">
                {% with item=listing, card_type='listing' %}
                    {% include '_card.html' %}
                {% endwith %}
            </div>
        {% endfor %}
    {% else %}
        <div class="text-center py-10 bg-base-100 rounded-xl shadow"><p class="text-xl text-gray-500">No available listings found in cache.</p></div>
    {% endif %}
    <div id="noListingsMessage" class="text-center py-10 bg-base-100 rounded-xl shadow" style="display: none;">
        <p class="text-xl text-gray-500">No listings match your criteria.</p>
    </div>
    </div> 
</main>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const globalSearchInput = document.getElementById('filter-global-listings');
    const filterRatingSelect = document.getElementById('filter-rating-listings');
    const sortCriteriaSelect = document.getElementById('sort-criteria-listings');
    const listingsContainer = document.getElementById('listingsContainer');
    const resetFiltersButton = document.getElementById('reset-filters-listings');
    const noResultsMessageEl = document.getElementById('noListingsMessage');

    if (!globalSearchInput) return; // Stop script if controls aren't on this page

    const originalListings = Array.from(listingsContainer.querySelectorAll('.listing-card-item'));

    function applyFiltersAndSort() {
        const globalSearchTerm = globalSearchInput.value.toLowerCase().trim();
        const ratingFilter = filterRatingSelect.value;
        const sortValue = sortCriteriaSelect.value;
        
        let visibleItems = [];
        originalListings.forEach(item => {
            const searchableContent = item.dataset.searchableContent || '';
            const rating = item.dataset.rating;
            
            const globalMatch = globalSearchTerm === '' || searchableContent.includes(globalSearchTerm);
            const ratingMatch = ratingFilter === '' || rating === ratingFilter;
            
            if (globalMatch && ratingMatch) {
                item.style.display = '';
                visibleItems.push(item);
            } else {
                item.style.display = 'none';
            }
        });
        
        // Sorting and DOM update logic here...
        noResultsMessageEl.style.display = visibleItems.length > 0 ? 'none' : 'block';
    }

    globalSearchInput.addEventListener('input', applyFiltersAndSort);
    filterRatingSelect.addEventListener('change', applyFiltersAndSort);
    sortCriteriaSelect.addEventListener('change', applyFiltersAndSort);
    resetFiltersButton.addEventListener('click', () => {
        globalSearchInput.value = '';
        filterRatingSelect.value = '';
        sortCriteriaSelect.value = 'creation_date_desc';
        applyFiltersAndSort();
    });

    applyFiltersAndSort();
});
</script>
{% endblock %}